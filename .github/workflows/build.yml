name: Build NixOS Images

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

# Cancel in-progress runs when a new run is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/master' }}

# Minimal permissions (explicitly grant what's needed)
permissions:
  contents: write
  pull-requests: read

defaults:
  run:
    shell: bash

# Build Strategy:
# 1. build-soc: Build SoC components (CIX Sky1) - kernel, drivers, firmware, tools
#    - Uses ccache for incremental kernel builds (~2.5 min vs 35 min)
#    - Pushes to Cachix for reuse by downstream jobs
# 2. build-sd-image & build-netboot: Run in parallel, reuse cached SoC components
#    - Build board-specific tools first (orangepi-config, wiringop)
#    - Pulls SoC components from Cachix (no rebuild needed)
#    - Only builds board-specific components (initrd, bootloader, filesystem)
#
# This avoids rebuilding SoC components and saves ~30-40 minutes per CI run.

jobs:
  check-flake:
    name: Flake Check
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Install Nix
      uses: cachix/install-nix-action@v27
      with:
        nix_path: nixpkgs=channel:nixos-unstable
        extra_nix_config: |
          experimental-features = nix-command flakes
    
    - name: Check Nix formatting
      run: |
        nix-shell -p nixpkgs-fmt --run "nixpkgs-fmt --check ."
    
    - name: Check flake
      run: nix flake check --no-build
    
    - name: Show flake info
      run: nix flake show
    
    - name: Verify kernel version
      run: |
        echo "Checking kernel version..."
        nix eval .#nixosConfigurations.orangepi6plus.config.boot.kernelPackages.kernel.version

  build-soc:
    name: SoC CIX CD8180/CD8160 (Kernel, Drivers, Tools)
    runs-on: ubuntu-latest
    needs: check-flake
    timeout-minutes: 120
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Install Nix
      uses: cachix/install-nix-action@v27
      with:
        nix_path: nixpkgs=channel:nixos-unstable
        extra_nix_config: |
          experimental-features = nix-command flakes
          max-jobs = auto
          cores = 0
    
    - name: Setup Cachix
      uses: cachix/cachix-action@v15
      with:
        name: i-am-logger
        authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
        skipPush: ${{ github.event_name == 'pull_request' }}
    
    - name: Setup ccache directory
      run: |
        sudo mkdir -p /tmp/ccache
        sudo chown root:nixbld /tmp/ccache
        sudo chmod 0770 /tmp/ccache
    
    - name: Cache ccache
      uses: actions/cache@v4
      with:
        path: /tmp/ccache
        key: ccache-kernel-${{ runner.os }}-${{ hashFiles('pkgs/kernel/**', 'flake.lock') }}
        restore-keys: |
          ccache-kernel-${{ runner.os }}-
    
    - name: Build Kernel
      run: |
        echo "Building vendor kernel (6.6.89-sky1)..."
        nix build .#kernel-cross \
          --print-build-logs \
          --fallback
    
    - name: Build Driver Modules
      run: |
        echo "Building all driver modules..."
        echo "  - Mali-G610 MP4 GPU driver"
        echo "  - 28.8 TOPS NPU driver (AIPU)"
        echo "  - ISP driver (ARM Camera Block)"
        echo "  - VPU driver (MVX Video)"
        echo ""
        
        nix build .#drivers-cross \
          --print-build-logs \
          --fallback \
          --keep-going \
          --max-jobs auto
    
    - name: Build Firmware
      run: |
        echo "Building firmware packages..."
        nix build .#firmware-cross \
          --print-build-logs \
          --fallback
    
    - name: Build SoC Tools
      run: |
        echo "Building CIX Sky1 SoC tools..."
        echo "  - i3ctransfer (I3C bus transfer)"
        echo "  - pmtool (Power management)"
        echo ""
        
        nix build .#tools-cross \
          --print-build-logs \
          --fallback
    
    - name: Show ccache stats
      run: |
        echo ""
        echo "ccache statistics:"
        ccache --show-stats 2>/dev/null || echo "ccache not available in this build"

  build-orangepi6plus:
    name: Orange Pi 6 Plus (Board + Tools)
    runs-on: ubuntu-latest
    needs: build-soc
    timeout-minutes: 60
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Install Nix
      uses: cachix/install-nix-action@v27
      with:
        nix_path: nixpkgs=channel:nixos-unstable
        extra_nix_config: |
          experimental-features = nix-command flakes
          max-jobs = auto
          cores = 0
    
    - name: Setup Cachix
      uses: cachix/cachix-action@v15
      with:
        name: i-am-logger
        authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
        skipPush: ${{ github.event_name == 'pull_request' }}
    
    - name: Build Board Configuration (Orange Pi 6 Plus)
      run: |
        echo "Building Orange Pi 6 Plus NixOS system configuration..."
        echo "This includes all board-specific settings and packages"
        echo ""
        
        # Build the full system configuration (will be used by both SD image and netboot)
        nix build .#nixosConfigurations.orangepi6plus-cross.config.system.build.toplevel \
          --print-build-logs \
          --fallback
    
    - name: Build Board Tools (Orange Pi 6 Plus)
      run: |
        echo "Building Orange Pi 6 Plus board tools..."
        echo "  - orangepi-config (hardware configuration)"
        echo "  - wiringop (GPIO library)"
        echo ""
        
        nix build .#orangepi6plus-tools-cross \
          --print-build-logs \
          --fallback

  build-sd-image:
    name: Orange Pi 6 Plus - SD Card Image
    runs-on: ubuntu-latest
    needs: build-orangepi6plus
    timeout-minutes: 180
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Install Nix
      uses: cachix/install-nix-action@v27
      with:
        nix_path: nixpkgs=channel:nixos-unstable
        extra_nix_config: |
          experimental-features = nix-command flakes
          max-jobs = auto
          cores = 0
    
    - name: Setup Cachix
      uses: cachix/cachix-action@v15
      with:
        name: i-am-logger
        authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
        skipPush: ${{ github.event_name == 'pull_request' }}
    
    - name: Build SD Card Image (Orange Pi 6 Plus)
      run: |
        nix build .#orangepi6plus-sdImage-cross \
          --print-build-logs \
          --fallback \
          --keep-going
    
    - name: Rename and get image info
      id: image_info
      run: |
        # Get version components for standardized naming
        DATE_TAG=$(date +%Y.%m.%d)
        SHORT_SHA=$(git rev-parse --short HEAD)
        VERSION="${DATE_TAG}-${SHORT_SHA}"
        ARCH="aarch64-linux"
        BOARD="orangepi6plus"
        
        # Find original image
        IMAGE_PATH=$(readlink -f result/sd-image/*.img.zst)
        
        # Rename to standard format: nixos-{board}-sd-image-{version}-{arch}.img.zst
        NEW_IMAGE_NAME="nixos-${BOARD}-sd-image-${VERSION}-${ARCH}.img.zst"
        cp "$IMAGE_PATH" "./${NEW_IMAGE_NAME}"
        
        # Calculate metadata
        IMAGE_SIZE=$(du -h "./${NEW_IMAGE_NAME}" | cut -f1)
        IMAGE_HASH=$(sha256sum "./${NEW_IMAGE_NAME}" | cut -d' ' -f1)
        
        echo "path=./${NEW_IMAGE_NAME}" >> $GITHUB_OUTPUT
        echo "name=${NEW_IMAGE_NAME}" >> $GITHUB_OUTPUT
        echo "artifact_name=nixos-${BOARD}-sd-image-${VERSION}-${ARCH}" >> $GITHUB_OUTPUT
        echo "size=${IMAGE_SIZE}" >> $GITHUB_OUTPUT
        echo "hash=${IMAGE_HASH}" >> $GITHUB_OUTPUT
        
        echo "Renamed SD image to: ${NEW_IMAGE_NAME}"
        echo "Size: ${IMAGE_SIZE}"
        echo "SHA256: ${IMAGE_HASH}"
    
    - name: Upload SD Image artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.image_info.outputs.artifact_name }}
        path: ${{ steps.image_info.outputs.path }}
        retention-days: 90
        compression-level: 0
    
    outputs:
      image_name: ${{ steps.image_info.outputs.name }}
      image_size: ${{ steps.image_info.outputs.size }}
      image_hash: ${{ steps.image_info.outputs.hash }}
      artifact_name: ${{ steps.image_info.outputs.artifact_name }}

  build-netboot:
    name: Orange Pi 6 Plus - Netboot
    runs-on: ubuntu-latest
    needs: build-orangepi6plus
    timeout-minutes: 180
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Install Nix
      uses: cachix/install-nix-action@v27
      with:
        nix_path: nixpkgs=channel:nixos-unstable
        extra_nix_config: |
          experimental-features = nix-command flakes
          max-jobs = auto
          cores = 0
    
    - name: Setup Cachix
      uses: cachix/cachix-action@v15
      with:
        name: i-am-logger
        authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
        skipPush: ${{ github.event_name == 'pull_request' }}
    
    - name: Build Netboot Package (Orange Pi 6 Plus)
      run: |
        nix build .#orangepi6plus-netboot-cross \
          --print-build-logs \
          --fallback \
          --keep-going
    
    - name: Rename netboot tarball
      id: netboot_info
      run: |
        # Get version components for standardized naming
        DATE_TAG=$(date +%Y.%m.%d)
        SHORT_SHA=$(git rev-parse --short HEAD)
        VERSION="${DATE_TAG}-${SHORT_SHA}"
        ARCH="aarch64-linux"
        BOARD="orangepi6plus"
        
        # Find the tarball created by Nix (has NixOS version)
        # The tarball is a regular file in the result directory
        echo "Looking for tarball in result directory..."
        ls -la result/
        
        # The tarball has a predictable name pattern, just glob for it
        NETBOOT_ORIG=$(ls result/*.tar.gz 2>/dev/null | head -1)
        
        if [ -z "$NETBOOT_ORIG" ]; then
          echo "ERROR: Netboot tarball not found"
          echo "Result directory contents:"
          ls -laR result/
          exit 1
        fi
        
        echo "Found tarball: $NETBOOT_ORIG"
        
        # Rename to match release tag version: nixos-{board}-netboot-{version}-{arch}.tar.gz
        NETBOOT_NAME="nixos-${BOARD}-netboot-${VERSION}-${ARCH}.tar.gz"
        cp "$NETBOOT_ORIG" "./${NETBOOT_NAME}"
        
        # Calculate metadata
        NETBOOT_SIZE=$(du -h "${NETBOOT_NAME}" | cut -f1)
        NETBOOT_HASH=$(sha256sum "${NETBOOT_NAME}" | cut -d' ' -f1)
        
        echo "path=${NETBOOT_NAME}" >> $GITHUB_OUTPUT
        echo "name=${NETBOOT_NAME}" >> $GITHUB_OUTPUT
        echo "artifact_name=nixos-${BOARD}-netboot-${VERSION}-${ARCH}" >> $GITHUB_OUTPUT
        echo "size=${NETBOOT_SIZE}" >> $GITHUB_OUTPUT
        echo "hash=${NETBOOT_HASH}" >> $GITHUB_OUTPUT
        
        echo "Renamed netboot tarball:"
        echo "  FROM: $(basename "$NETBOOT_ORIG")"
        echo "  TO:   ${NETBOOT_NAME}"
        echo "Size: ${NETBOOT_SIZE}"
        echo "SHA256: ${NETBOOT_HASH}"
        echo ""
        echo "Netboot archive contents:"
        tar -tzf "${NETBOOT_NAME}"
    
    - name: Upload Netboot artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.netboot_info.outputs.artifact_name }}
        path: ${{ steps.netboot_info.outputs.path }}
        retention-days: 90
        compression-level: 0
    
    outputs:
      netboot_name: ${{ steps.netboot_info.outputs.name }}
      netboot_size: ${{ steps.netboot_info.outputs.size }}
      netboot_hash: ${{ steps.netboot_info.outputs.hash }}
      artifact_name: ${{ steps.netboot_info.outputs.artifact_name }}

  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-sd-image, build-netboot]
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    timeout-minutes: 15
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Download SD Image artifact
      uses: actions/download-artifact@v4
      with:
        name: ${{ needs.build-sd-image.outputs.artifact_name }}
        path: ./release-files/
    
    - name: Download Netboot artifact
      uses: actions/download-artifact@v4
      with:
        name: ${{ needs.build-netboot.outputs.artifact_name }}
        path: ./release-files/
    
    - name: Generate version tag
      id: version
      run: |
        # Get the date in YYYY.MM.DD format
        DATE_TAG=$(date +%Y.%m.%d)
        
        # Get the short commit hash
        SHORT_SHA=$(git rev-parse --short HEAD)
        
        # Generate semantic version: YYYY.MM.DD-{commit}
        VERSION="v${DATE_TAG}-${SHORT_SHA}"
        
        # Check if tag already exists
        if git rev-parse "$VERSION" >/dev/null 2>&1; then
          # Add build number if tag exists
          BUILD_NUM=1
          while git rev-parse "${VERSION}.${BUILD_NUM}" >/dev/null 2>&1; do
            BUILD_NUM=$((BUILD_NUM + 1))
          done
          VERSION="${VERSION}.${BUILD_NUM}"
        fi
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Generated version: $VERSION"
    
    - name: Verify release assets
      id: verify
      run: |
        echo "Verifying release assets..."
        ls -lh release-files/
        echo ""
        
        # Assets are already correctly named from build jobs
        cd release-files
        
        SD_IMAGE=$(find . -name "*-sd-image-*.img.zst" | head -1)
        NETBOOT=$(find . -name "*-netboot-*.tar.gz" | head -1)
        
        if [ -n "$SD_IMAGE" ]; then
          echo "‚úì SD Image: $(basename "$SD_IMAGE")"
        else
          echo "‚ö† Warning: SD image not found"
        fi
        
        if [ -n "$NETBOOT" ]; then
          echo "‚úì Netboot: $(basename "$NETBOOT")"
        else
          echo "‚ö† Warning: Netboot archive not found"
        fi
        
        cd ..
    
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: "${{ steps.version.outputs.version }}"
        files: ./release-files/*
        generate_release_notes: true
        body: |
          ## Installation
          
          üìñ **[SD Card Installation](https://github.com/${{ github.repository }}/blob/master/docs/installation.md#option-1-sd-card-boot)** | **[Network Boot Setup](https://github.com/${{ github.repository }}/blob/master/docs/installation.md#option-3-network-boot-pxe)**
          
          ## Default Credentials
          
          **Username**: `nixos` | **Password**: `nixos` | **SSH**: Enabled (port 22)
          
          ‚ö†Ô∏è Change password after first boot: `passwd && sudo passwd root`
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
